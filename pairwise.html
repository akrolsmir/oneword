<!DOCTYPE html>
<meta charset="utf-8" />

<head>
  <title>Pairwise</title>
  <link
    href="https://fonts.googleapis.com/css?family=Fjalla+One|Merienda+One|Righteous|Sriracha&display=swap"
    rel="stylesheet"
  />
  <script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>
  <link rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html {
      margin: 0;
      height: 100%;
      background-color: #fcd6d8;
      position: relative;
      overflow: auto;
    }

    .fancy {
      font-family: 'Merienda One', cursive;
      margin-top: 16px;
      font-size: 24px;
    }

    .fancy.big {
      margin-top: 0;
      font-size: 40px;
    }

    .fancy.normal {
      margin-top: 0;
      font-size: 100%;
    }

    body {
      margin: 48px auto;
      width: 1200px;
      max-width: 95vw;
    }

    .spacy {
      white-space: pre-wrap;
    }

    .label {
      margin-top: 20px;
    }

    .newline {
      white-space: pre-wrap;
    }

    .capitalize {
      text-transform: capitalize;
    }

    .comma:not(:last-child):after {
      content: ', ';
    }

    .tag {
      font-size: 0.875rem !important; /* Bulma's normal tag (0.75 rem) is too small and medium tag (1 rem) is too big */
    }

    [v-cloak] {
      display: none;
    }

    /* TODO replace w/ bulma-collapsible extension  */
    .collapsible {
      background-color: #f59fa4;
      color: white;
      cursor: pointer;
      padding: 18px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 15px;
    }

    /* TODO replace w/ bulma-collapsible extension  */
    .content {
      overflow: hidden;
      transition: max-height 0.2s ease-out;
      background-color: #f1f1f1;
    }
  </style>

  <meta name="description" content="Pick a phrase, trick your friends, find the pair!" />

  <!-- Dolphin favicon courtesy of Twemoji -->
  <link rel="icon" href="https://twemoji.maxcdn.com/v/13.0.1/72x72/1f990.png" />
</head>

<body class="has-navbar-fixed-top">
  <div id="vue">
    <navbar ref="navbar" v-model="user"></navbar>
    <!-- Notification -->
    <div class="modal" :class="{'is-active': alertIsShowing}">
      <div class="modal-background" @click="alertIsShowing=false"></div>
      <div class="modal-content">
        <div class="notification">
          <label class="is-block mb-2">Invite your friends to play!</label>
          <sharelink :link="'https://oneword.games/pairwise?room=' + room.name"></sharelink>
          <button class="delete" aria-label="close" @click="alertIsShowing=false"></button>
        </div>
      </div>
    </div>
    <!-- Column-based layout for leader board, Main UI, and Chat box -->
    <div class="columns is-centered">
      <!-- Left pane is for leader board. Only shown in-game and when width > 1216px -->
      <div class="column">
        <leaderboard
          :state="room.currentRound.state"
          :history="room.history"
          :players="room.players"
          :total="gameOverPoints"
          v-on:gameover="handleGameOver"
        ></leaderboard>
      </div>
      <!-- Center (main) pane. TODO: Remove the below to get prettier formatting again -->
      <!-- prettier-ignore -->
      <div class="column is-two-thirds is-half-widescreen">
        <!-- Home page -->
        <div v-if="!room.players" class="container mx-4">
          <div class="notification is-link has-text-centered">
            Try our new team-vs-team word game (that's actually ready for testers), <a href="incrypt.html">Incrypt</a>!
          </div>
          <!-- // Commented out b/c rendering lags too much -->
          <!-- <div v-if="player.name">Hi {{ player.name }}!</div> -->
          <div class="fancy big">Welcome to Pairwise!</div>
          This is an online word game inspired by
          <strong><a target="_blank" rel="noopener noreferrer" href="https://amazon.com/dp/2914849656">Dixit</a></strong>, originally a picture-based
          board game. <br />
          Write a clue, trick your friends, find the pair! <br />
          But beware: If your clue is either too obvious or too off the wall, your friends will get ahead!<br />
          <form v-if="user.id || user.guest" @submit.prevent="enterRoom" method="POST">
            <label class="label">Player</label>
            <input class="input" type="text" v-model="player.name" placeholder="Ringo" />
            <label class="label">Room</label>
            <input class="input" type="text" v-model="room.name" placeholder="apple" required /><br /><br />
            <input class="button" type="submit" value="Enter Room" />
          </form>
          <template v-else-if="player.currentRoom">
            <h2 class="fancy">
              <a @click="$refs.navbar.logIn()">Sign In</a> to join Room: <span><strong>{{ player.currentRoom }}</strong></span>
            </h2>
            <a @click='$set(user, "guest", true)' class="is-size-10">Or play without an account</a>
          </template>
          <template v-else>
            <br />
            <button class="button is-large is-success" @click="$refs.navbar.logIn()">Sign in to get started</button><br />
            <a @click='$set(user, "guest", true)' class="is-size-7">Play without an account</a>
          </template>
          <br />
          <br />
          <h2 class="fancy">Open Rooms</h2>
          <p>Alpha Testing Stage</p>
          <!-- <template v-for="openRoom in allRooms">
            <p>
              <a @click="room.name = openRoom.name; enterRoom()"><b>{{ openRoom.name }}</b></a
              >, with {{ openRoom.players.join(', ') }} ({{ moment(openRoom.lastUpdateTime).fromNow() }})
            </p>
          </template> -->
        </div>
        <!-- In game -->
        <div v-cloak v-else class="container mx-4">
          <div class="message">
            <!-- Room header -->
            <div class="message-header has-text-weight-normal is-flex-wrap-wrap">
              <h1 class="fancy big">{{ room.name }}</h1>
              <span class="fancy capitalize">Round {{ room.history.length + 1 }}</span>
              <!-- Navigation -->
              <span class="buttons are-small">
                <button class="button is-dark is-inverted is-outlined" @click="alertIsShowing=true">Invite</button>
                <button
                  v-if="room.players.includes(player.name)"
                  class="button is-dark is-inverted is-outlined"
                  @click="kickPlayer(player.name)"
                >
                  Watch
                </button>
                <button v-else class="button is-dark is-inverted is-outlined" @click="joinRoom">Rejoin</button>
                <button class="button is-danger is-inverted is-outlined" @click="kickPlayer(player.name); goHome();">
                  Exit
                </button>
              </span>
            </div>
            <div>
              <div class="is-flex is-flex-wrap-wrap is-align-items-center">
                <!-- Supporter Settings -->
                <!-- <span
                  title="Supporter settings"
                  class="py-1 pl-1 pr-4"
                  style="background: #ffef99; clip-path: polygon(0 0, 0 100%, 93% 100%, 100% 0)"
                > -->
                <!-- <div class="mx-1" v-if="isMod">
                  <span class="select is-small">
                      <select v-model="room.public" @change="upsell('public')">
                      <option v-bind:value="true">Public</option>
                      <option v-bind:value="false">Private</option>
                      </select>
                  </span>
                  <span class="select is-small">
                    <select v-model="room.roundsInGame" @change="upsell('roundsInGame')">
                    <option v-bind:value="13">13 rounds</option>
                    <option v-bind:value="'Unlimited'">&infin; rounds</option>
                    </select>
                  </span>
                </div> -->
                <!-- <template v-else>
                    <span class="mx-2">{{ room.public ? 'Public' : 'Private' }} Room</span>
                    <span class="mx-2">{{ room.roundsInGame == 'Unlimited' ? '&infin;' : room.roundsInGame}} rounds</span>
                  </template>
                </span> -->

                <!-- Timers -->
                <!-- <span class="ml-1 mr-2 my-1 is-flex is-align-items-center">
                  <template v-if="isMod">
                    <label for="clue-timer" class="is-size-7 mx-1 is-flex-grow-1">Clue:</label>
                    <input
                      class="input is-small"
                      style="flex: 1 2 48px"
                      id="clue-timer"
                      type="number"
                      min="1"
                      max="99"
                      placeholder="&infin;"
                      v-model.number="room.timers.CLUEING"
                      :disabled="room.timers.running"
                    />
                    <label for="guess-timer" class="is-size-7 mx-1 is-flex-grow-1">Guess:</label>
                    <input
                      class="input is-small"
                      style="flex: 1 2 48px"
                      id="guess-timer"
                      type="number"
                      min="1"
                      max="99"
                      placeholder="&infin;"
                      v-model.number="room.timers.GUESSING"
                      :disabled="room.timers.running"
                    />
                    <button class="button is-small mx-1 is-flex-grow-1" @click="toggleTimers">
                      {{ room.timers.running ? 'Stop' : 'Start' }} Timers
                    </button>
                  </template>
                  <template v-else>
                    <template v-if="room.timers.running">
                      <span v-if="room.timers.CLUEING" class="mx-2">Clue: {{ room.timers.CLUEING }}s</span>
                      <span v-if="room.timers.GUESSING" class="mx-2">Guess: {{ room.timers.GUESSING }}s</span>
                    </template>
                    <span v-else class="mx-1">No timers</span>
                  </template>
                </span> -->

                <!-- Categories -->
                <span v-if="isMod" class="field is-grouped is-grouped-multiline mx-3 my-1">
                  <!-- <div class="control" v-for="category in this.CATEGORY_ORDER">
                    <label class="capitalize checkbox">
                      <input type="checkbox" v-model="room.categories[category]" @change="saveRoom('categories')" />
                      {{ category }}
                    </label>
                  </div> -->
                </span>
                <span class="mx-3" v-else>
                  <!-- <template v-for="(category, i) in this.CATEGORY_ORDER.filter(c => room.categories[c])">
                    <span class="comma" :class="{'has-text-weight-bold': room.currentRound.category == category}">
                      {{ category }}</span
                    >
                  </template> -->
                </span>
              </div>
              <!-- Custom word editor (mod only) -->
              <!-- <div v-if="isMod && room.categories['custom']" class="is-flex is-justify-content-center">
                <div class="field mb-2" style="width: 500px; max-width: 90%">
                  <div class="control">
                    <textarea
                      class="textarea is-small mb-2"
                      :class="{'is-primary': wordsSaved}"
                      placeholder="Input your own word list"
                      v-model="room.customWords"
                      @input="wordsSaved = false"
                    ></textarea>
                  </div>
                  <div class="control">
                    <button v-if="wordsSaved" class="button is-small" disabled>Saved</button>
                    <button v-else class="button is-small" @click="wordsSaved = true; saveRoom('customWords');">
                      Save
                    </button>
                  </div>
                </div>
              </div> -->
            </div>

            <div class="message-body" style="border-width: 0">
              <!-- Players -->
              <div class="field is-grouped is-grouped-multiline">
                <span class="mb-2 mr-2">Players:</span>
                <!-- TODO: refactor submitted/guessing into functions. This is currently a hack -->
                <nametag
                  v-for="(player, i) in room.players"
                  :name="player"
                  :user="room.playerData && room.playerData[player]"
                  :index="i"
                  :submitted="(Object.keys(room.currentRound.allWords).includes(player) && player != room.currentRound.clueGiver) || (player == room.currentRound.clueGiver && !Object.keys(room.currentRound.allWords).includes(player))"
                  :guessing="Object.keys(room.currentRound.votes).includes(player) || (player == room.currentRound.clueGiver && Object.keys(room.currentRound.allWords).includes(player))"
                  :mod="isMod"
                  @kick="kickPlayer(player)"
                ></nametag>
              </div>
              <!-- Not sure if this works... -->
              <!-- Other Mod Tools -->
              <!-- <div v-if="isMod">
                <div class="label">Room Controls</div>
                <div class="field has-addons is-inline-flex mb-0">
                  <span class="control">
                    <button class="button is-small" @click="nextStage">Next Stage</button>
                  </span>
                  <span class="control">
                    <button class="button is-small" @click="newRound(true)">Skip Word</button>
                  </span>
                </div>
                <div class="field has-addons is-inline-flex">
                  <span class="control">
                    <button class="button is-small" @click="makeMod(newMod)">Transfer Mod</button>
                  </span>
                  <span class="control">
                    <span class="select is-small">
                      <select v-model="newMod">
                        <option v-for="player in this.room.players.slice(1)">{{ player }}</option>
                      </select>
                    </span>
                  </span>
                </div>
              </div> -->
            </div>
          </div>
          <!-- <timer :length="timerLength" :on-finish="nextStage" v-if="timerLength > 0" :key="room.currentRound.state"></timer> -->

          <!-- Input area (CLUER_PICKING) -->
          <div v-if="room.currentRound.state == 'CLUER_PICKING'">
            <div v-if="room.players.length < 3">
              <h2 class="fancy" role="alert">Waiting for 3 players...</h2>
              <p class="mt-5 mb-2">Invite your friends to play!</p>
              <sharelink :link="'https://oneword.games/pairwise?room=' + room.name"></sharelink>
            </div>
            <!-- TODO consider adding limit of 10 players so games aren't too big? -->
            <!-- If there are enough players to play -->
            <div v-else>
              <!-- Current player's turn to pick a word and give clues -->
              <div v-if="room.currentRound.clueGiver == player.name">
                <div class="box">
                  <h2 class="fancy has-text-centered" role="alert">
                    Pick a phrase among the following, and write a clue that describes it in the clue box!
                    <br /><br />
                    <button
                      class="button is-rounded"
                      @click="cluerSelectsWord(word)"
                      v-for="(word, i) in player.wordList"
                      :class="{ 'is-info': room.currentRound.word == word }"
                    >
                      {{ word }}
                    </button>
                  </h2>
                  <label class="label" for="hintInput">Your clue</label>
                  <div class="field has-addons">
                    <div class="control is-expanded">
                      <input
                        class="input"
                        id="hintInput"
                        type="text"
                        v-model="room.currentRound.clue"
                        @keyup.enter="submitClue"
                        :class="{'is-primary': true}"
                      />
                    </div>
                    <div class="control">
                      <!-- TODO: add tool tip to show why button is disabled https://wikiki.github.io/elements/tooltip/ -->
                      <button class="button" @click="submitClue" :disabled="isClueSubmitDisabled()">
                        Submit
                      </button>
                    </div>
                  </div>
                  <!-- <div class="notification is-danger" role="alert" v-if="hasSpecialCharacters(room.currentRound.clue)">
                    Are you sure this is a real word?
                  </div> -->
                </div>
              </div>
              <!-- Not current player's turn -->
              <div v-else>
                <h2 class="fancy" role="alert">
                  Waiting for <strong>{{ room.currentRound.clueGiver }}</strong> to pick a phrase and a clue...
                </h2>
                <br/>
              </div>
              <button class="collapsible" @click="showGameRules = !showGameRules"> How the game works </button> 
              <div class="content" v-bind:style="{'max-height': !showGameRules ? '0px' : 'inherit', 'padding': !showGameRules ? '0px' : '18px'}">
                <strong>1)</strong> Wait for <strong>{{ room.currentRound.clueGiver }}</strong> to pick a random pair of words (i.e. a phrase), and write some text (i.e. the clue) that relates to the phrase
                <br/> <strong>2)</strong> Based on the clue, everyone else constructs a decoy phrase they think best matches the clue
                <br/> <strong>3)</strong> Once all decoys are submitted, players try to guess <strong>{{ room.currentRound.clueGiver }}</strong>'s real phrase among the decoys
              </div>
            </div>
          </div>

          <!-- Input area (toossing in decoys) -->
          <div v-if="room.currentRound.state == 'TOSS_IN_DECOYS'">
            <!-- All except the clueGiver guesses which word is the real one, based on the clue giver's clues. -->
            <div class="box">
              <div v-if="room.currentRound.clueGiver != player.name">
                <h2 class="fancy has-text-centered" role="alert">
                  Pick one option from each word category to construct a decoy phrase best matching <strong>{{ room.currentRound.clueGiver }}</strong>'s clue.
                  <br /><br />
                </h2>
                <div class="columns">
                  <!-- Left pane is for leader board. Only shown in-game and when width > 1216px -->
                  <div class="column has-text-centered">
                    <strong> Adjectives </strong> 
                    <br/><br/>
                    <button
                      class="button is-rounded"
                      @click="player.decoyAdj = word"
                      v-for="(word, i) in player.decoyAdjList"
                      :class="{ 'is-success': player.decoyAdj === word }"
                    >
                      {{ word }}
                    </button>
                  </div>
                  <!-- Center (main) pane. TODO: Remove the below to get prettier formatting again -->
                  <!-- prettier-ignore -->
                  <div class="column has-text-centered">
                    <strong> Nouns </strong> 
                    <br/><br/>
                    <button
                      class="button is-rounded"
                      @click="player.decoyNoun = word"
                      v-for="(word, i) in player.decoyNounList"
                      :class="{ 'is-success': player.decoyNoun === word }"
                    >
                      {{ word }}
                    </button>
                  </div>
                </div>
                <div class="has-text-centered">
                  Your decoy phrase:
                  <span v-if="player.decoyAdj || player.decoyNoun">
                    <strong>"{{ player.decoyAdj }}-{{ player.decoyNoun }}"</strong>
                  </span>
                  <br/>
                  <br/>
                  <button class="button" @click="submitDecoy" :class="{ 'is-success': room.currentRound.allWords[player.name] }" :disabled="isDecoySubmitDisabled()">{{ room.currentRound.allWords[player.name] ? 'Submitted!' : 'Submit' }}</button>
                </div>
                <h2 class="fancy has-text-centered" role="alert">Your clue from {{ room.currentRound.clueGiver }} is: <strong>{{ room.currentRound.clue }}</strong> </h2>
              </div>
              <div v-else>
                <h2 class="fancy" role="alert">Waiting for other players to toss in decoys based on your clue...</h2>
                <br/>
                <div class="has-text-centered"> <strong>{{ room.currentRound.clue }}</strong> </div>
                <h2 class="fancy has-text-centered" role="alert">
                  <span
                    class="tag is-rounded is-primary is-light"
                    v-for="(word, decoyTosser) in room.currentRound.allWords"
                  >
                    <template v-if="decoyTosser != player.name"> {{ decoyTosser }} tossed in "{{ word }}"! </template>
                    <template v-else>You chose the word "{{ word }}"</template>
                </span>
                </h2>
              </div>
            </div>
          </div>

          <!-- Input area (guessing) -->
          <div v-if="room.currentRound.state == 'GUESSING'">
            <!-- All except the clueGiver guesses which word is the real one, based on the clue giver's clues. -->
            <div class="box">
              <div v-if="room.currentRound.clueGiver == player.name">
                <h2 class="fancy has-text-centered" role="alert">
                  <button
                    class="button is-rounded"
                    v-for="word in Object.values(room.currentRound.allWords).sort()"
                    :disabled="true"
                    :class="{ 'is-success': Object.values(room.currentRound.votes).includes(word) }"
                  >
                    {{ word }}
                  </button>
                </h2>
                <div class="fancy has-text-centered newline">Waiting for other players to guess... </div>
                <div class="has-text-centered" >You aren't allowed to guess your own word, sorry!</div>

              </div>
              <div v-else>
                <h2 class="fancy has-text-centered" role="alert">
                  Can you find the right word from {{ room.currentRound.clueGiver }} among the decoys.. ?
                  <br /><br />
                  <button
                    class="button is-rounded"
                    @click="submitVote(word)"
                    v-for="word in Object.values(room.currentRound.allWords).sort()"
                    :disabled="room.currentRound.allWords[player.name] == word"
                    :class="{ 'is-success': room.currentRound.votes[player.name] == word }"
                  >
                    {{ word }}
                  </button>
                </h2>
                <h2 class="fancy has-text-centered">Your clue from {{ room.currentRound.clueGiver }}:</h2>
                <div class="fancy has-text-centered newline">{{ room.currentRound.clue }}</div>
              </div>
            </div>
          </div>

          <!-- Input area (done) -->
          <div v-if="room.currentRound.state == 'DONE'">
            <div class="box">
              <h2 class="fancy has-text-centered" role="alert">
              The phrase from <strong>{{ room.currentRound.clueGiver }}</strong> was "{{ room.currentRound.word }}"!
              </h2>
              <br />
            </div>
            <div class="box">
              <div v-for="(vote, player) in room.currentRound.votes">
                <strong> {{ player }} </strong> guessed "{{ vote }}"!
              </div>
            </div>
            <div v-if="gameOver" class="box">
              And that's it! <strong> {{ gameWinner }} </strong> won with "{{ winnerPoints }} points"!
              <!-- <button class="button" @click="newRound(false)">Play Again</button> -->
            </div>
            <button v-else class="button" @click="newRound(false)">Next</button>
          </div>
          <br /><br />
          <!-- History TO ADD LATER -->
          <!-- <h2 v-if="room.history.length > 0" class="fancy">History</h2>
          <template v-for="(round, i) in room.history.slice().reverse()">
            <div class="level">
              <div class="level-left">
                <span class="level-item" style="justify-content: flex-start">
                  <span
                    class="icon"
                    :class="correct(round) ? 'has-text-success' : 'has-text-danger'"
                    :aria-label="correct(round) ? 'correct' : 'incorrect'"
                  >
                    {{ correct(round) ? '✔' : '✖' }}
                  </span>
                  <span class="fancy normal">{{ room.history.length - i }}. {{ round.word }} ({{ round.category }})</span>
                </span>
                <p class="level-item" style="justify-content: flex-start">
                  {{ round.guesser }} guessed "<b :class="correct(round) ? 'has-text-success' : 'has-text-danger'"
                    >{{ round.guess }}</b
                  >"
                </p>
              </div>
            </div>
            <p class="newline">{{ dedupe(round.clues) }}</p>
            <br />
          </template> -->
        </div>
      </div>
      <!-- Right pane for chat (to be implemented) -->
      <div class="column is-hidden-touch is-hidden-desktop-only">
        <!-- Spacer div to get chatbox to line up with game area -->
        <!-- <div class="mb-2">
          <div class="is-size-7 mb-1"><br /></div>
          <div><br /></div>
        </div>
        <chatbox v-model="room.chatlog" :name="player.name" :room-id="room.name"></chatbox> -->
      </div>
    </div>
  </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.2/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.24.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert@2.1.2/dist/sweetalert.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.13.0/js/md5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pluralize@8.0.0/pluralize.js"></script>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/7.8.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.8.1/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.8.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.8.1/firebase-firestore.js"></script>

<!-- My code -->
<script type="module" src="components/nametag.js"></script>
<script type="module" src="components/scoreboard.js"></script>
<script type="module" src="components/sharelink.js"></script>
<script type="module" src="components/pairwise/navbarshawn.js"></script>
<script type="module" src="components/pairwise/leaderboard.js"></script>
<script type="module" src="pairwise.js"></script>

<script>
  window.COLLECTION = 'wordit-shawn';
</script>
